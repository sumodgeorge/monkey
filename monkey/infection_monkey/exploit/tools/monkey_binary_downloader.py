"""
Class used for downloading and saving monkey binaries to local machine
so it can be uploaded to the target
"""
import os

from infection_monkey import monkeyfs
from infection_monkey.exploit.tools.helpers import get_target_monkey_by_os


class MonkeyBinaryDownloader:
    TEMP_MONKEY_BINARY_FILEPATH = './monkey_temp_bin.exe'

    def __init__(self, is_windows: bool, is_32bit: bool):
        self.is_windows = is_windows
        self.is_32bit = is_32bit

    def __enter__(self):
        return self.download_to_local_machine()

    def __exit__(self, exc_type, exc_val, exc_tb):
        MonkeyBinaryDownloader.delete_from_local_machine()

    def download_to_local_machine(self):
        monkey_fs_path = get_target_monkey_by_os(is_windows=self.is_windows,
                                                 is_32bit=self.is_32bit)
        # write virtual file to actual local file
        with monkeyfs.open(monkey_fs_path) as monkey_virtual_file:
            with open(MonkeyBinaryDownloader.TEMP_MONKEY_BINARY_FILEPATH, 'wb') as monkey_local_file:
                monkey_local_file.write(monkey_virtual_file.read())
        return MonkeyBinaryDownloader.TEMP_MONKEY_BINARY_FILEPATH

    @staticmethod
    def delete_from_local_machine():
        os.remove(MonkeyBinaryDownloader.TEMP_MONKEY_BINARY_FILEPATH)
